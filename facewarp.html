<!DOCTYPE html>
<html>
  <head>
    <title>facewarp.js demo</title>
  </head>
  <body>
    <script src="lightgl.js"></script>
    <script type="x-shader/x-vertex" id="vs-coords">
varying vec2 coord;      
void main() {
  coord = gl_TexCoord.xy;
  //gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;
  gl_Position = gl_Vertex;
}
    </script>
    <script type="x-shader/x-fragment" id="fs-warp">
uniform sampler2D storage;
uniform sampler2D texture;
varying vec2 coord;
void main() {
  vec4 raw = texture2D(storage, coord);
  vec2 texCoord = vec2(raw.r + raw.g/256.0, raw.b + raw.a/256.0);
  //vec2 texCoord = vec2(raw.r, raw.b);
  gl_FragColor = texture2D(texture, texCoord);
}       
    </script>
    <script type="x-shader/x-fragment" id="fs-init">
varying vec2 coord;
void main() {
  gl_FragColor = vec4(coord.x, 256.0 * mod(coord.x, 256.0),
                      coord.y, 256.0 * mod(coord.y, 256.0));  
}
    </script>
    <script type="x-shader/x-fragment" id="fs-update">
uniform sampler2D storage;
varying vec2 coord;
void main() {
  vec4 cur = texture2D(storage, coord);
  gl_FragColor = vec4(cur.ba, cur.rg);  
}
    </script>

    <script>
// initialize WebGL
var gl = GL.create();

// create a plane mesh
// (there's only gl_Vertex buffer by default; `coords` adds gl_TexCoord)
var mesh = GL.Mesh.plane({coords: true, normals: true});

// initialize shaders from the <script> elements with supplied ids
var warpShader = new GL.Shader('vs-coords', 'fs-warp');
var storageInitShader = new GL.Shader('vs-coords', 'fs-init');
var storageUpdateShader = new GL.Shader('vs-coords', 'fs-update');

// load texture
var texture = new GL.Texture.fromURL("pattern.jpg");

// create storage (actually a texture) for texture coordinates
var storage = new GL.Texture(texture.width, texture.height);
//var storage = new GL.Texture(1024, 1024);

storage.drawTo(function() {
  storageInitShader.draw(mesh);
});

// update
gl.onupdate = function() {
  return; // disable update for now
  // update the storage
  storage.drawTo(function() {
    storage.bind(0);
    storageUpdateShader.draw(mesh);
  });
}

// drawing
gl.ondraw = function() {
  
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  gl.loadIdentity();
  //gl.translate(0, 0, -2.4);

  storage.bind(0);
  texture.bind(1);
  warpShader.uniforms({
    storage: 0,
    texture: 1
  }).draw(mesh);
}

// use whole window (fullscreen() also conveniently injects a <canvas> element)
gl.fullscreen();

// start running the onupdate/ondraw loop
gl.animate();
    </script>
  </body>
</html>
